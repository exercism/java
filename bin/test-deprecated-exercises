#!/usr/bin/env bash
set -eo pipefail

# Determine the base branch of the PR
BASE_BRANCH=${GITHUB_BASE_REF:-main}

# Fetch full history for proper diff
git fetch origin "$BASE_BRANCH"

# Compute merge base
MERGE_BASE=$(git merge-base HEAD origin/"$BASE_BRANCH")

# Get changed files relative to merge base
changed_files=$(git diff --name-only "$MERGE_BASE" HEAD)

# Extract unique exercise directories
changed_exercises=$(echo "$changed_files" | grep -E '^exercises/(practice|concept)/' || true)
changed_exercises=$(echo "$changed_exercises" | cut -d/ -f1-3 | sort -u)

# Early exit if no exercise changed
if [ -z "$changed_exercises" ]; then
  echo "No exercises changed!"
  exit 0
fi

# Load deprecated exercises from config.json
deprecated_exercises=$(jq -r '
  [ 
    (.exercises.concept[]? | select(.status=="deprecated") | "exercises/concept/" + .slug),
    (.exercises.practice[]? | select(.status=="deprecated") | "exercises/practice/" + .slug)
  ] | .[]
' config.json)

# Check for deprecated ones
for ex in $changed_exercises; do
  if echo "$deprecated_exercises" | grep -qx "$ex"; then
    echo "❌ Deprecated exercise changed: $ex"
    exit 1
  fi
done

echo "✅ No deprecated exercises changed!"
