#!/usr/bin/env bash
set -eo pipefail

# Determine the base branch of the PR
BASE_BRANCH=${GITHUB_BASE_REF:-main}

# Fetch full history for proper diff
git fetch origin "$BASE_BRANCH"

# Compute merge base
MERGE_BASE=$(git merge-base HEAD origin/"$BASE_BRANCH")

# Get changed files relative to merge base
changed_files=$(git diff --name-only "$MERGE_BASE" HEAD)

# If any Gradle build file changed, run the full suite and exit
if echo "$changed_files" | grep -qE '\.(gradle|gradlew|bat)$|settings\.gradle'; then
  echo "Gradle build files changed, running full test suite..."
  ./bin/test-with-test-runner
  exit 0
fi

# Extract unique exercise directories
changed_exercises=$(echo "$changed_files" | \
  grep -E '^exercises/(practice|concept)/[^/]+/.+\.java$' | \
  cut -d/ -f1-3 | sort -u)

if [ -z "$changed_exercises" ]; then
  echo "No relevant exercises changed, skipping tests."
  exit 0
fi

# Print exercises
echo "Changed exercises detected:"
echo "$changed_exercises"
echo "----------------------------------------"

summary_dir="exercises/build"
summary_file="${summary_dir}/summary.txt"
mkdir -p "$summary_dir"

# Run tests
exit_code=0
for dir in $changed_exercises; do
  slug=$(basename "$dir")

  echo "========================================"
  echo "=== Running tests for $slug ==="
  echo "========================================"

  results_path="$dir/build/results.txt"
  mkdir -p "$(dirname "$results_path")"

  if [[ $dir == exercises/practice/* ]]; then
    ./exercises/gradlew -p exercises ":practice:$slug:test" 2>&1 | tee "$results_path" || true
  elif [[ $dir == exercises/concept/* ]]; then
    ./exercises/gradlew -p exercises ":concept:$slug:test" 2>&1 | tee "$results_path" || true
  fi

  # Detect failure
  if grep -q "FAILED" "$results_path"; then
    exit_code=1

    # Determine practice/slug or concept/slug
    relative_path=$(echo "$dir" | sed 's|^exercises/||')

    # Create summary.txt with header only on first failure
    if [ ! -f "$summary_file" ]; then
        echo "The following exercises have test failures or test errors:" > "$summary_file"
    fi

    # Append the correct path (practice/slug or concept/slug)
    echo "$relative_path" >> "$summary_file"
  fi

done

exit $exit_code